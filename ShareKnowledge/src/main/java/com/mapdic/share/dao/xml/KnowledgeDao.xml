<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--必须与接口同名-->
<mapper namespace="com.mapdic.share.dao.KnowledgeDao">
    <resultMap id="KnowledgeMap" type="com.mapdic.share.model.Knowledge">
        <result property="k_id" column="k_id"/>
        <result column="tag" property="tag"/>
        <result column="content" property="content"/>
        <result column="orcontent" property="orcontent"/>
        <result column="language" property="language"/>
        <result column="category" property="category"/>
        <result column="system" property="system"/>
        <result column="filepath" property="filePath"/>
        <result column="ischeck" property="isCheck"/>
        <result column="isforbidden" property="isForbidden"/>
        <result column="date" property="date"/>
        <result column="title" property="title"/>
        <association property="user" javaType="com.mapdic.share.model.User">
                <id column="userid" property="id"/>
                <result column="username" property="userName"/>
                <result column="passwd" property="passWd"/>
                <result column="ic" property="IC"/>
                <result column="phone" property="phone"/>
                <result column="qq" property="qq"/>
                <result column="mail" property="mail"/>
                <result column="level" property="level"/>
        </association>
    </resultMap>

    <sql id="columns">
        k_id,tag,content,orcontent,language,category,title,userid,system,filepath,ischeck,isforbidden,date
    </sql>
    <update id="updateKnowledge" parameterType="com.mapdic.share.model.Knowledge">
        UPDATE knowledge
        <set>
            <if test="tag != null">
                tag = #{tag},
            </if>
            <if test="content != null">
                content = #{content},
            </if>
            <if test="orcontent != null">
                orcontent = #{orcontent},
            </if>
            <if test="language != 0">
                language = #{language, jdbcType=TINYINT},
            </if>
            <if test="category != 0">
                category = #{category, jdbcType=TINYINT},
            </if>
            <if test="title != null">
                title = #{title},
            </if>
            <if test="system != null">
                system = #{system},
             </if>
            <if test="filePath != null">
                filepath = #{filePath},
            </if>
            <if test="isCheck != 0">
                ischeck = #{isCheck, jdbcType=TINYINT},
            </if>
            <if test="isForbidden != 0">
                isforbidden = #{isForbidden, jdbcType=TINYINT},
            </if>
            <if test="date != null">
                date = #{date},
            </if>
        </set>
        <where>k_id = #{k_id}</where>
    </update>
        <insert id="addKnowledge" useGeneratedKeys="true" keyProperty="k_id" parameterType="com.mapdic.share.model.Knowledge">
            INSERT INTO KNOWLEDGE
            (
              tag,title,content,orcontent,language,category,userid,system,filepath,ischeck,isforbidden,date
            )
            VALUES
            (
              #{tag},#{title} ,#{content},#{orcontent}, #{language, jdbcType=TINYINT}, #{category, jdbcType=TINYINT}, #{user.id}, #{system}, #{filePath},#{isCheck, jdbcType=TINYINT},#{isForbidden, jdbcType=TINYINT},#{date}
            )
        </insert>
    <select id="getKnowledgeByUser" parameterType="java.lang.Integer" resultMap="KnowledgeMap">
        SELECT
        <include refid="columns"/>
        FROM KNOWLEDGE
        WHERE userid = #{userId}
    </select>
    <select id="getKnowledgeNotInUser" parameterType="java.lang.Integer" resultMap="KnowledgeMap">
        SELECT
        <include refid="columns"/>
        FROM KNOWLEDGE
        WHERE userid  &lt;&gt; #{userId}
    </select>
    
    <select id="getTop5Knowledge" parameterType="java.lang.Integer" resultMap="KnowledgeMap">
        SELECT
        <include refid="columns"/>
        FROM KNOWLEDGE
        WHERE userid = #{userId}
        AND ischeck=1
        ORDER BY date desc
        LIMIT 0, 5
    </select>
    <select id="countKnowledge" parameterType="java.lang.Integer" resultType="java.lang.Integer">
        SELECT count(*)
         FROM  KNOWLEDGE
         WHERE userid = #{userId} AND
         ischeck=1
    </select>
    <select id="countKnowledgeByCid" parameterType="java.lang.Integer" resultType="java.lang.Integer">
        SELECT count(*)
         FROM  KNOWLEDGE
        WHERE
        <if test="cid != 0">
            category = #{cid} AND
        </if>
          ischeck=1
    </select>

    <select id="getKnowledgeByPage" parameterType="java.lang.Integer" resultMap="KnowledgeMap">
        SELECT
        <include refid="columns"/>
        FROM  KNOWLEDGE
        WHERE userid = #{uid} AND ischeck=1
        ORDER BY date DESC
        limit #{start}, #{end}
    </select>
    <select id="getKnowledgeByUserCategory" parameterType="java.lang.Integer" resultMap="KnowledgeMap">
        SELECT
        <include refid="columns"/>
        FROM  KNOWLEDGE
        WHERE
        <if test="cid != 0">
            category = #{cid} AND
        </if>
        ischeck=1
        ORDER BY date DESC
        limit #{start}, #{end}
    </select>
    <select id="getKnowledgeByCategory" parameterType="java.lang.Integer" resultMap="KnowledgeMap">
        SELECT
        <include refid="columns"/>
        FROM  KNOWLEDGE
        WHERE
        <if test="cid != 0">
            category = #{cid} AND
        </if>
        ischeck=1
        ORDER BY title DESC
    </select>

    <select id="getKnowledgeByKid" parameterType="java.lang.Integer" resultMap="KnowledgeMap">
        SELECT
        <include refid="columns"/>
        FROM  KNOWLEDGE
        WHERE k_id = #{kid} AND ischeck=1
    </select>

    <select id="getKnowledgeByUidKid"  resultMap="KnowledgeMap">
        SELECT
        <include refid="columns"/>
        FROM  KNOWLEDGE
        WHERE k_id = #{kid} AND ischeck=1 AND userid=#{uid}
    </select>

    <delete id="delKnowledge">
        DELETE FROM
         KNOWLEDGE
        WHERE userid=#{uid} AND k_id = #{kid}
    </delete>
</mapper>